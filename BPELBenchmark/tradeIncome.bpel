<!-- tradeIncome BPEL Process [Generated by the Eclipse BPEL Designer] -->
<!--
Copyright (C) 2012 Álvaro Cortijo García

Permission is hereby granted, free of charge, to any person obtaining a 
copy of this software and associated documentation files (the "Software"), 
to deal in the Software without restriction, including without limitation 
the rights to use, copy, modify, merge, publish, distribute, sublicense, 
and/or sell copies of the Software, and to permit persons to whom the 
Software is furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in 
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR 
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, 
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE 
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, 
WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN 
CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
-->
<process name="tradeIncome"
         targetNamespace="http://www.uca.es/bpel/tradeIncome"
         suppressJoinFailure="yes"
         xmlns:tns="http://www.uca.es/bpel/tradeIncome"
         xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
         xmlns:ns1="http://www.example.org/tradeIncome/" xmlns:ns2="http://www.w3.org/2001/XMLSchema">
         
	<!-- Import the client WSDL -->
	<import namespace="http://www.example.org/tradeIncome/" location="tradeIncome.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"></import>
	<import location="tradeIncomeArtifacts.wsdl" namespace="http://www.uca.es/bpel/tradeIncome" 
			      importType="http://schemas.xmlsoap.org/wsdl/" />

	<!-- ================================================================= -->         
	<!-- ORCHESTRATION LOGIC                                               -->
	<!-- Set of activities coordinating the flow of messages across the    -->
	<!-- services integrated within this business process                  -->
	<!-- ================================================================= -->         
	<partnerLinks>
		<partnerLink name="tradeManagement" partnerLinkType="tns:ManagementPLTN" myRole="ManagementRole"></partnerLink>
		<partnerLink name="IncomeRank" partnerLinkType="tns:RankPLTN" partnerRole="RankRole"></partnerLink>
		<partnerLink name="tradeControl" partnerLinkType="tns:EstablishmentsControlPLTN" partnerRole="EstablishmentsControlRole"></partnerLink>
		<partnerLink name="Establishment1" partnerLinkType="tns:Establishment1PLTN" myRole="Establishment1Role"></partnerLink>
		<partnerLink name="Establishment2" partnerLinkType="tns:Establishment2PLTN" myRole="Establishment2Role"></partnerLink>
		<partnerLink name="Accounting" partnerLinkType="tns:AccountingPLTN" myRole="AccountingRole"></partnerLink>
		<partnerLink name="marketingTrade" partnerLinkType="tns:MarketingPLTN" myRole="MarketingRole"></partnerLink>
	</partnerLinks>

	<messageExchanges>
		<messageExchange name="managementMessage"></messageExchange>
	</messageExchanges>

	<variables>
		<variable name="tradeManagementIn" messageType="ns1:ManagementOperationRequest"></variable>
		<variable name="tradeManagementOut" messageType="ns1:ManagementOperationResponse"></variable>
		<variable name="sill" messageType="ns1:RankOperationResponse"></variable>
		<variable name="RankIn" messageType="ns1:RankOperationRequest"></variable>
		<variable name="establishmentsControlOut" messageType="ns1:EstablishmentsControlOperationRequest"></variable>
		<variable name="establishment1In" messageType="ns1:EstablishmentOperationRequest"></variable>
		<variable name="establishment2In" messageType="ns1:EstablishmentOperationRequest"></variable>
		<variable name="n_sections1" type="ns2:int"></variable>
		<variable name="n_sections2" type="ns2:int"></variable>
		<variable name="counter1" type="ns2:int"></variable>
		<variable name="counter2" type="ns2:int"></variable>
		<variable name="sectionProfits" type="ns2:double"></variable>
		<variable name="tradeError" messageType="ns1:ManagementOperationFault"></variable>
		<variable name="trimestralTaxation" messageType="ns1:AccountingOperationRequest"></variable>
		<variable name="offersIn" messageType="ns1:OffersOperationRequest"></variable>
		<variable name="advertisingIn" messageType="ns1:AdvertisingOperationRequest"></variable>
		<variable name="n_offers" type="ns2:int"></variable>
		<variable name="section" type="ns2:string"></variable>
	</variables>

	<correlationSets>
		<correlationSet name="tradeCorrelation" properties="tns:incomeDate"></correlationSet>
	</correlationSets>

	<faultHandlers>
		<catch faultMessageType="ns1:RankOperationFault" faultName="ns1:rankfault" faultVariable="error">
			<sequence>
				<assign validate="no" name="RankFaultAssign">
					<copy>
						<from part="parameters" variable="error">
							<query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
								<![CDATA[RankFault]]>
							</query>
						</from>
						<to>$tradeError.parameters/ManagementFault</to>
					</copy>
				</assign>
				<reply name="ReplyRankFault" partnerLink="tradeManagement" operation="ManagementOperation" portType="ns1:ManagementPT" faultName="ns1:managementfault" variable="tradeError" messageExchange="managementMessage"></reply>
			</sequence>
		</catch>
		<catch faultName="UnknownSectionsName">
			<sequence>
				<assign name="UnknownSectionsNameError">
					<copy>
						<from><![CDATA[concat($tradeError.parameters/ManagementFault,' Unknown sections name')]]></from>
						<to>$tradeError.parameters/ManagementFault</to>
					</copy>
				</assign>
				<reply name="ReplySectionsNameFault" partnerLink="tradeManagement" operation="ManagementOperation" portType="ns1:ManagementPT" faultName="ns1:managementfault" variable="tradeError" messageExchange="managementMessage"></reply>
			</sequence>
		</catch>
		<catch faultName="NoSectionsFounded">
			<sequence>
				<assign name="NoSectionsFoundedError">
					<copy>
						<from><![CDATA[concat($tradeError.parameters/ManagementFault,' No sections founded')]]></from>
						<to>$tradeError.parameters/ManagementFault</to>
					</copy>
				</assign>
				<reply name="ReplyNoSectionsFault" partnerLink="tradeManagement" operation="ManagementOperation" portType="ns1:ManagementPT" faultName="ns1:managementfault" variable="tradeError" messageExchange="managementMessage"></reply>
			</sequence>
		</catch>
		<catch faultName="ObtainedNegativeRank">
			<reply name="ReplyNegativeRankFault" partnerLink="tradeManagement" operation="ManagementOperation" portType="ns1:ManagementPT" faultName="ns1:managementfault" variable="tradeError" messageExchange="managementMessage"></reply>
		</catch>
	</faultHandlers>

	<sequence name="main">
		<flow name="Flow">
			<links>
				<link name="managementReceive"></link>
				<link name="establishment1Receive1"></link>
				<link name="establishment2Receive1"></link>
				<link name="establishment1Receive2"></link>
				<link name="establishment2Receive2"></link>
				<link name="marketingPick"></link>
			</links>
			<receive name="Receive" partnerLink="tradeManagement" operation="ManagementOperation" portType="ns1:ManagementPT" createInstance="yes" variable="tradeManagementIn" messageExchange="managementMessage">
				<correlations>
					<correlation set="tradeCorrelation" initiate="join"></correlation>
				</correlations>
				<sources>
					<source linkName="managementReceive"></source>
				</sources>
			</receive>
			<receive name="Receive1" partnerLink="Establishment1" operation="EstablishmentOperation" portType="ns1:EstablishmentPT" variable="establishment1In" createInstance="yes">
				<correlations>
					<correlation set="tradeCorrelation" initiate="join"></correlation>
				</correlations>
				<sources>
					<source linkName="establishment1Receive1"></source>
					<source linkName="establishment1Receive2"></source>
				</sources>
			</receive>
			<receive name="Receive2" partnerLink="Establishment2" operation="EstablishmentOperation" portType="ns1:EstablishmentPT" variable="establishment2In" createInstance="yes">
				<correlations>
					<correlation set="tradeCorrelation" initiate="join"></correlation>
				</correlations>
				<sources>
					<source linkName="establishment2Receive1"></source>
					<source linkName="establishment2Receive2"></source>
				</sources>
			</receive>
			<scope name="Scope">
				<targets>
					<target linkName="managementReceive"></target>
					<target linkName="establishment1Receive1"></target>
					<target linkName="establishment2Receive1"></target>
				</targets>
				<sequence name="Sequence">
					<assign validate="no" name="InitiateVariables">
						<copy>
							<from>
								<literal>
									<tns:ManagementOperationResponse xmlns:tns="http://www.example.org/tradeIncome/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
										<profits>0.0</profits>
										<income>0.0</income>
										<costs>0.0</costs>
										<profitPass>profitPass</profitPass>
										<bestSection>
											<name>name</name>
											<establishment>0</establishment>
											<profits>-1000000.0</profits>
										</bestSection>
										<totalStock>0</totalStock>
										<deals>
											<sectionsUnits>0</sectionsUnits>
											<offers>
												<offer>
													<section>section</section>
													<percent>0.0</percent>
												</offer>
											</offers>
										</deals>
										<advertising>
											<ad>
												<media>media</media>
												<cost>0.0</cost>
											</ad>
										</advertising>
										<marketing>marketing</marketing>
										<reports>none</reports>
									</tns:ManagementOperationResponse>
								</literal>
							</from>
							<to part="parameters" variable="tradeManagementOut"></to>
						</copy>
						<copy>
							<from>1</from>
							<to variable="counter2"></to>
						</copy>
						<copy>
							<from>
								<literal>
									<tns:EstablishmentsControlOperation xmlns:tns="http://www.example.org/tradeIncome/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
										<controlInformation>controlInformation</controlInformation>
										<controlDate>2001-01-01</controlDate>
									</tns:EstablishmentsControlOperation>
								</literal>
							</from>
							<to variable="establishmentsControlOut" part="parameters"></to>
						</copy>
						<copy>
							<from>
								<literal>
									<tns:RankOperation xmlns:tns="http://www.example.org/tradeIncome/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
										<requestDate>2001-01-01</requestDate>
									</tns:RankOperation>
								</literal>
							</from>
							<to variable="RankIn" part="parameters"></to>
						</copy>
						<copy>
							<from>
								<literal>
									<tns:ManagementOperationFault xmlns:tns="http://www.example.org/tradeIncome/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
										<ManagementFault>ManagementFault</ManagementFault>
									</tns:ManagementOperationFault>
								</literal>
							</from>
							<to variable="tradeError" part="parameters"></to>
						</copy>
						<copy>
							<from>
								<literal>
									<tns:AccountingOperation xmlns:tns="http://www.example.org/tradeIncome/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
										<accountingDate>2001-01-01</accountingDate>
										<taxation>0.0</taxation>
									</tns:AccountingOperation>
								</literal>
							</from>
							<to variable="trimestralTaxation" part="parameters"></to>
						</copy>
					</assign>
					<pick name="Pick">
						<onMessage partnerLink="marketingTrade" operation="OffersOperation" portType="ns1:MarketingPT" variable="offersIn">
							<correlations>
								<correlation set="tradeCorrelation" initiate="join"></correlation>
							</correlations>
							<assign validate="no" name="offersAssign">
							<sources>
								<source linkName="marketingPick"></source>
							</sources>
								<copy>
									<from part="parameters" variable="offersIn">
										<query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[offers]]></query>
									</from>
									<to>$tradeManagementOut.parameters/deals/offers</to>
								</copy>
								<copy>
									<from>
										<literal xml:space="preserve">Offers will be applied the next month</literal>
									</from>
									<to>$tradeManagementOut.parameters/marketing</to>
								</copy>
							</assign>
						</onMessage>
						<onMessage partnerLink="marketingTrade" operation="AdvertisingOperation" portType="ns1:MarketingPT" variable="advertisingIn">
							<correlations>
								<correlation set="tradeCorrelation" initiate="join"></correlation>
							</correlations>
							<assign validate="no" name="adsAssign">
								<copy>
									<from part="parameters" variable="advertisingIn">
										<query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[advertising]]></query>
									</from>
									<to>$tradeManagementOut.parameters/advertising</to>
								</copy>
								<copy>
									<from>
										<literal xml:space="preserve">Ads will be make the next month</literal>
									</from>
									<to>$tradeManagementOut.parameters/marketing</to>
								</copy>
							</assign>
						</onMessage>
						<onAlarm>
							<for><![CDATA['PT7S']]></for>
							<assign validate="no" name="noMarketingAssign">
								<copy>
									<from>
										<literal xml:space="preserve">No marketing applied.</literal>
									</from>
									<to>$tradeManagementOut.parameters/marketing</to>
								</copy>
							</assign>
						</onAlarm>
					</pick>
				</sequence>
			</scope>
			<scope name="Scope1">
				<targets>
					<target linkName="establishment1Receive2"></target>
					<target linkName="establishment2Receive2"></target>
					<target linkName="marketingPick"></target>
					<joinCondition>$establishment1Receive2 and $establishment2Receive2 and $marketingPick</joinCondition>
				</targets>
				<sequence name="Sequence">
					<assign validate="no" name="establishmentsOffersAssign">
						<copy>
							<from><![CDATA[count($offersIn.parameters/offers/offer)]]></from>
							<to variable="n_offers"></to>
						</copy>
					</assign>
					<forEach counterName="counter_offers" name="offersWhile" parallel="no">
						<startCounterValue>1</startCounterValue>
						<finalCounterValue>$n_offers</finalCounterValue>
						<scope name="offersScope" isolated="no">
							<sequence>
								<assign validate="no" name="unitsSectionAssign">
									<copy>
										<from part="parameters" variable="offersIn">
											<query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
												<![CDATA[offers/offer[$counter_offers]/section]]>
											</query>
										</from>
										<to variable="section"></to>
									</copy>
								</assign>
								<assign name="unitsAssign" validate="no">
									<copy>
										<from>
											<![CDATA[sum($establishment1In.parameters/earnings/section[@name = $section]/costs/stock) + sum($establishment2In.parameters/earnings/section[@name = $section]/costs/stock) + $tradeManagementOut.parameters/deals/sectionsUnits]]>
										</from>
										<to>$tradeManagementOut.parameters/deals/sectionsUnits</to>
									</copy>
								</assign>
							</sequence>
						</scope>
					</forEach>
				</sequence>
			</scope>
		</flow>

		<assign validate="no" name="totalStockAssign">
			<copy>
				<from>
					<![CDATA[sum($establishment1In.parameters/earnings/section/costs/stock)]]>
				</from>
				<to>$tradeManagementOut.parameters/totalStock</to>
				</copy>
			<copy>
				<from>
					<![CDATA[sum($establishment2In.parameters/earnings/section/costs/stock) + $tradeManagementOut.parameters/totalStock]]>
				</from>
				<to>$tradeManagementOut.parameters/totalStock</to>
			</copy>
	   </assign>

		<scope name="calculateEarnings">
			<flow name="Flow1">
				<scope name="calculateEarningsE1">
					<sequence name="Sequence">
						<assign validate="no" name="sectionsNumberI">
							<copy>
								<from>
									<![CDATA[count($establishment1In.parameters/earnings/section)]]>
								</from>
								<to variable="n_sections1"></to>
							</copy>
						<copy>
							<from variable="n_sections1"></from>
							<to variable="counter1"></to>
						</copy>
						</assign>
						<if name="ErrorWithSections">
						<condition><![CDATA[$n_sections1 = 0]]></condition>
							<throw faultName="NoSectionsFounded" />
							<elseif>
							<condition><![CDATA[count($establishment1In.parameters/earnings/section/@name) < $n_sections1]]></condition>
								<throw faultName="UnknownSectionsName" />
							</elseif>
						</if>
						<while name="sumProfits">
						<condition><![CDATA[$counter1 != 0]]></condition>
							<scope name="calculateEstablishment1" isolated="yes">
								<sequence name="SumEstablishmentIncome">
									<assign validate="no" name="AssignEstablishmentIncome">
										<copy>
											<from>
												<![CDATA[$tradeManagementOut.parameters/income + sum($establishment1In.parameters/earnings/section[$counter1]/total)]]>
											</from>
											<to>$tradeManagementOut.parameters/income</to>
										</copy>
										<copy>
											<from>
												<![CDATA[$tradeManagementOut.parameters/costs + sum($establishment1In.parameters/earnings/section[$counter1]/costs/total)]]>
											</from>
											<to>$tradeManagementOut.parameters/costs</to>
										</copy>
										<copy>
											<from>
												<![CDATA[sum($establishment1In.parameters/earnings/section[$counter1]/total) - sum($establishment1In.parameters/earnings/section[$counter1]/costs/total)]]>
											</from>
											<to variable="sectionProfits"></to>
										</copy>
										<copy>
											<from>
												<![CDATA[$tradeManagementOut.parameters/profits + $sectionProfits]]>
											</from>
											<to>$tradeManagementOut.parameters/profits</to>
										</copy>
									</assign>
									<if name="ProfitsPerSection">
									<condition><![CDATA[$sectionProfits > $tradeManagementOut.parameters/bestSection/profits]]></condition>
										<assign validate="no" name="BestSectionName">
											<copy>
												<from part="parameters" variable="establishment1In">
													<query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
														<![CDATA[earnings/section[$counter1]/@name]]>
													</query>
												</from>
												<to>$tradeManagementOut.parameters/bestSection/name</to>
											</copy>
											<copy>
												<from>
													<literal xml:space="preserve">1</literal>
												</from>
												<to>$tradeManagementOut.parameters/bestSection/establishment</to>
											</copy>
											<copy>
												<from variable="sectionProfits"></from>
												<to>$tradeManagementOut.parameters/bestSection/profits</to>
											</copy>
										</assign>
									</if>
									<assign validate="no" name="Increase">
										<copy>
											<from>
												<![CDATA[-1 + $counter1]]>
											</from>
											<to variable="counter1"></to>
										</copy>
									</assign>
								</sequence>
							</scope>
						</while>
					</sequence>
					<terminationHandler>
						<assign validate="no" name="terminationAssign">
							<copy>
								<from>
									<literal xml:space="preserve">A fault occurred calculating earnings.</literal>
								</from>
								<to>$tradeError.parameters/ManagementFault</to>
							</copy>
						</assign>
					</terminationHandler>
				</scope>

				<scope name="calculateEarningsE2">
					<sequence name="Sequence">
						<assign validate="no" name="sectionsNumber2">
							<copy>
								<from>
									<![CDATA[count($establishment2In.parameters/earnings/section)]]>
								</from>
								<to variable="n_sections2"></to>
							</copy>
						</assign>
						<if name="ErrorWithSections2">
						<condition><![CDATA[$n_sections2 = 0]]></condition>
							<throw faultName="NoSectionsFounded" />
							<elseif>
							<condition><![CDATA[count($establishment2In.parameters/earnings/section/@name) < $n_sections2]]></condition>
								<throw faultName="UnknownSectionsName" />
							</elseif>
						</if>
						<while name="sumProfits2">
						<condition><![CDATA[$counter2 <= $n_sections2]]></condition>
							<scope name="calculateEstablishment2" isolated="yes">
								<sequence name="SumEstablishmentIncome2">
									<assign validate="no" name="AssignEstablishmentIncome2">
										<copy>
											<from>
												<![CDATA[$tradeManagementOut.parameters/income + sum($establishment2In.parameters/earnings/section[$counter2]/total)]]>
											</from>
											<to>$tradeManagementOut.parameters/income</to>
										</copy>
										<copy>
											<from>
												<![CDATA[$tradeManagementOut.parameters/costs + sum($establishment2In.parameters/earnings/section[$counter2]/costs/total)]]>
											</from>
											<to>$tradeManagementOut.parameters/costs</to>
										</copy>
										<copy>
											<from>
												<![CDATA[sum($establishment2In.parameters/earnings/section[$counter2]/total) - sum($establishment2In.parameters/earnings/section[$counter2]/costs/total)]]>
											</from>
											<to variable="sectionProfits"></to>
										</copy>
										<copy>
											<from>
												<![CDATA[$tradeManagementOut.parameters/profits + $sectionProfits]]>
											</from>
											<to>$tradeManagementOut.parameters/profits</to>
										</copy>
									</assign>
									<if name="ProfitsPerSection2">
									<condition><![CDATA[$sectionProfits > $tradeManagementOut.parameters/bestSection/profits]]></condition>
										<assign validate="no" name="BestSectionName">
											<copy>
												<from part="parameters" variable="establishment2In">
													<query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
														<![CDATA[earnings/section[$counter2]/@name]]>
													</query>
												</from>
												<to>$tradeManagementOut.parameters/bestSection/name</to>
											</copy>
											<copy>
												<from>
													<literal xml:space="preserve">2</literal>
												</from>
												<to>$tradeManagementOut.parameters/bestSection/establishment</to>
											</copy>
											<copy>
												<from variable="sectionProfits"></from>
												<to>$tradeManagementOut.parameters/bestSection/profits</to>
											</copy>
										</assign>
									</if>
									<assign validate="no" name="Increase2">
										<copy>
											<from>
												<![CDATA[1 + $counter2]]>
											</from>
											<to variable="counter2"></to>
										</copy>
									</assign>
								</sequence>
							</scope>
						</while>
					</sequence>
					<terminationHandler>
						<assign validate="no" name="terminationAssign2">
							<copy>
								<from>
									<literal xml:space="preserve">A fault occurred calculating earnings.</literal>
								</from>
								<to>$tradeError.parameters/ManagementFault</to>
							</copy>
						</assign>
					</terminationHandler>
				</scope>
			</flow>
		</scope>

		<scope name="setDecision">
			<sequence>
				<assign validate="no" name="RankAssign">
					<copy>
						<from part="parameters" variable="tradeManagementIn">
							<query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
								<![CDATA[requestDate]]>
							</query>
						</from>
						<to>$RankIn.parameters/requestDate</to>
					</copy>
				</assign>
				<invoke name="Invoke" partnerLink="IncomeRank" operation="RankOperation" portType="ns1:RankPT" inputVariable="RankIn" outputVariable="sill">
					<correlations>
						<correlation set="tradeCorrelation" pattern="request"></correlation>
					</correlations>
				</invoke>
				<scope name="ProfitsRank">
					<sequence>
						<assign validate="no" name="establishmentsControlAssign">
							<copy>
								<from part="parameters" variable="tradeManagementIn">
									<query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[requestDate]]></query>
								</from>
								<to>$establishmentsControlOut.parameters/controlDate</to>
							</copy>
							<copy>
								<from>
									<literal xml:space="preserve">The information of the establishments have been processed correctly</literal>
								</from>
								<to>$establishmentsControlOut.parameters/controlInformation</to>
							</copy>
						</assign>
						<invoke name="Invoke1" partnerLink="tradeControl" operation="EstablishmentsControlOperation" portType="ns1:EstablishmentsControlPT" inputVariable="establishmentsControlOut" outputVariable="establishmentsControlOut">
							<correlations>
								<correlation set="tradeCorrelation" pattern="request"></correlation>
							</correlations>
						</invoke>
						<if name="ProfitsSwitch">
						<condition>
							<![CDATA[$tradeManagementOut.parameters/profits >= $sill.parameters/profitsAmount]]>
						</condition>
							<assign validate="no" name="ProfitSill">
								<copy>
									<from>
										<literal xml:space="preserve">Profitable</literal>
									</from>
									<to>$tradeManagementOut.parameters/profitPass</to>
								</copy>
							</assign>
							<else>
								<assign validate="no" name="LossesSill">
									<copy>
										<from>
											<literal xml:space="preserve">Losses</literal>
										</from>
										<to>$tradeManagementOut.parameters/profitPass</to>
									</copy>
								</assign>
							</else>
						</if>
					</sequence>
					<compensationHandler>
						<sequence>
							<assign validate="no" name="ProfitsSillCompensate">
								<copy>
									<from>
										<literal xml:space="preserve">undefined</literal>
									</from>
									<to>$tradeManagementOut.parameters/profitPass</to>
								</copy>
								<copy>
									<from>
										<literal xml:space="preserve">An error ocurred. The information of the establishment will be needed again</literal>
									</from>
									<to>$establishmentsControlOut.parameters/controlInformation</to>
								</copy>
							</assign>
							<invoke name="EstablishmentsControlInvoke" partnerLink="tradeControl" operation="EstablishmentsControlOperation" portType="ns1:EstablishmentsControlPT" inputVariable="establishmentsControlOut"></invoke>
						</sequence>
					</compensationHandler>
				</scope>
				<if name="NegativeRank">
				<condition><![CDATA[$sill.parameters/profitsAmount < 0]]></condition>
					<throw name="Throw" faultName="ObtainedNegativeRank"></throw>
				</if>
			</sequence>
			<faultHandlers>
				<catch faultName="ObtainedNegativeRank">
					<sequence>
						<compensate name="ProfitsRank"></compensate>
						<assign validate="no" name="ObtainedNegativeRankError">
							<copy>
								<from>
									<![CDATA[concat('Obtained Negative Rank. Actually, profitPass decision is ', $tradeManagementOut.parameters/profitPass)]]>
								</from>
								<to>$tradeError.parameters/ManagementFault</to>
							</copy>
						</assign>
						<rethrow></rethrow>
					</sequence>
				</catch>
			</faultHandlers>
			<eventHandlers>
				<onAlarm>
					<until><![CDATA['2082-12-31T00:00:00Z']]></until>
					<scope>
						<assign validate="no" name="reportsAssign">
							<copy>
								<from>
									<literal xml:space="preserve">Anual report should be done.</literal>
								</from>
								<to>$tradeManagementOut.parameters/reports</to>
							</copy>
						</assign>
					</scope>
				</onAlarm>
			</eventHandlers>
		</scope>

		<assign validate="no" name="ApplyTrimestralTaxation">
			<copy>
				<from>
					<![CDATA[-$trimestralTaxation.parameters/taxation + $tradeManagementOut.parameters/profits]]>
				</from>
				<to>$tradeManagementOut.parameters/profits</to>
			</copy>
		</assign>

		<reply name="Reply" partnerLink="tradeManagement" operation="ManagementOperation" portType="ns1:ManagementPT" variable="tradeManagementOut" messageExchange="managementMessage"></reply>

	</sequence>

	<eventHandlers>
		<onEvent partnerLink="tradeManagement" operation="ManagementAbortOperation" portType="ns1:ManagementPT"  messageType="ns1:ManagementAbortOperationRequest" variable="managementAborted">
			<correlations>
				<correlation set="tradeCorrelation" initiate="join"></correlation>
			</correlations>
			<scope>
				<sequence>
					<assign validate="no" name="AbortedAssign">
						<copy>
							<from>
								<literal>
									<tns:ManagementOperationFault xmlns:tns="http://www.example.org/tradeIncome/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
										<ManagementFault>ManagementFault</ManagementFault>
									</tns:ManagementOperationFault>
								</literal>
							</from>
							<to variable="tradeError" part="parameters"></to>
						</copy>
						<copy>
							<from>
								<![CDATA[concat('Trade management aborted. The reason is: ',$managementAborted.parameters/reason)]]>
							</from>
							<to>$tradeError.parameters/ManagementFault</to>
						</copy>
					</assign>
					<reply name="AbortedReply" partnerLink="tradeManagement" operation="ManagementOperation" portType="ns1:ManagementPT" faultName="ns1:managementfault" variable="tradeError" messageExchange="managementMessage"></reply>
				</sequence>
			</scope>
		</onEvent>
		<onEvent partnerLink="Accounting" operation="AccountingOperation" portType="ns1:AccountingPT" variable="AccountingRequest" messageType="ns1:AccountingOperationRequest">
			<correlations>
				<correlation set="tradeCorrelation" initiate="join"></correlation>
			</correlations>
			<scope>
				<sequence>
					<assign validate="no" name="AccountingAssign">
						<copy>
							<from>
								<literal>
									<tns:AccountingOperation xmlns:tns="http://www.example.org/tradeIncome/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
										<accountingDate>2001-01-01</accountingDate>
										<taxation>0.0</taxation>
									</tns:AccountingOperation>
								</literal>
							</from>
							<to variable="trimestralTaxation" part="parameters"></to>
						</copy>
						<copy>
							<from part="parameters" variable="AccountingRequest">
								<query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[taxation]]></query>
							</from>
							<to>$trimestralTaxation.parameters/taxation</to>
						</copy>
						<copy>
							<from part="parameters" variable="AccountingRequest">
								<query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[accountingDate]]></query>
							</from>
							<to>$trimestralTaxation.parameters/accountingDate</to>
						</copy>
					</assign>
				</sequence>
			</scope>
		</onEvent>
	</eventHandlers>
</process>

